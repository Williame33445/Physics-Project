<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query CERN Figures</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/query_styles.css') }}">
    <script>
        function startDictation() {
            if (window.hasOwnProperty('webkitSpeechRecognition')) {
                var recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = "en-US";
                recognition.start();

                recognition.onresult = function(e) {
                    document.getElementById('mainQuery').value = e.results[0][0].transcript;
                    recognition.stop();
                };

                recognition.onerror = function(e) {
                    recognition.stop();
                }
            }
        }

        function toggleAdvancedOptions() {
            var checkBox = document.getElementById("advancedOption");
            var advancedFields = document.getElementById("advancedFields");
            advancedFields.style.display = checkBox.checked ? "block" : "none";
        }

        function pasteLastQuery() {
            var lastQuery = localStorage.getItem('lastQuery');
            if (lastQuery) {
                document.getElementById('mainQuery').value = lastQuery;
            }
        }

        function toggleHistory() {
            var historyDiv = document.getElementById('searchHistory');
            var containerDiv = document.getElementById('container');
            historyDiv.style.display = historyDiv.style.display === 'none' ? 'block' : 'none';
            containerDiv.style.display = historyDiv.style.display === 'block' ? 'none' : 'block';
        }

        document.addEventListener("DOMContentLoaded", function() {
    var micBtn = document.getElementById("micBtn");
    micBtn.addEventListener("click", startDictation);

    var advancedOption = document.getElementById("advancedOption");
    advancedOption.addEventListener("change", toggleAdvancedOptions);

    var pasteLastQueryBtn = document.getElementById("pasteLastQueryBtn");
    pasteLastQueryBtn.style.display = localStorage.getItem('lastQuery') ? "inline" : "none";
    
    // Add event listener for the pasteLastQueryBtn button
    pasteLastQueryBtn.addEventListener("click", function() {
        var lastQuery = localStorage.getItem('lastQuery');
        if (lastQuery) {
            document.getElementById('mainQuery').value = lastQuery;
        }
    });

    document.querySelector("form").addEventListener("submit", function() {
        var query = document.getElementById('mainQuery').value;
        localStorage.setItem('lastQuery', query);
        pasteLastQueryBtn.style.display = "inline";
    });
});
    </script>
</head>
<body>
    <div id="container" class="container">
        <h1>Search CERN Figures</h1>
        <form action="/search" method="post">
            <div class="input-group">
                <input type="text" id="mainQuery" name="mainQuery" required>
                <button type="button" id="micBtn" aria-label="Speak" class="mic-btn">
                    <i class="fas fa-microphone"></i>
                </button>
            </div><br>
            <div class="option-group">
                <input type="checkbox" id="advancedOption" name="advancedOption">
                <label for="advancedOption">Advanced Option</label>
            </div>
            <div id="advancedFields" style="display: none;">
                <label for="xAxis">X Axis:</label>
                <input type="text" id="xAxis" name="xAxis"><br><br>
                <label for="yAxis">Y Axis:</label>
                <input type="text" id="yAxis" name="yAxis"><br><br>
            </div>
            <input type="submit" value="Search">
            <button type="button" id="pasteLastQueryBtn" style="display: none;">Paste Last Query</button>
        </form>
    </div>
    {% if history %}
    <div class="history-btn-container">
        <button id="historyBtn" onclick="toggleHistory()">Toggle Search History</button>
        <form action="/clear_history" method="post" class="clear-history-form">
            <button type="submit">Clear Search History</button>
        </form>
    </div>

    <div id="searchHistory" style="display: none;">
        {% for entry in history %}
            <div class="history-entry">
                <p>Query: {{ entry.query }}</p>
                {% for result in entry.results %}
                    <div class="result">
                        {% if result.image_url %}
                            <p>Image: <img src="{{ result.image_url }}" alt="Figure Image" style="max-width:50%;height:auto;"></p>
                        {% endif %}
                        <p>Name: {{ result.name }}</p>
                        <p>Mentions: {{ result.mentions }}</p>
                        <p>Atlas URL: <a href="{{ result.atlusUrl }}" target="_blank">{{ result.atlusUrl }}</a></p>
                        <p>Paper ID: {{ result.paper }}</p>
                        <p>Paper Name: {{ result.paperName }}</p>
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>
    {% endif %}
</body>
</html>
